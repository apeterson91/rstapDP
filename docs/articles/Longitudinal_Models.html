<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Longitudinal Models • rstapDP</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Longitudinal Models">
<meta property="og:description" content="rstapDP">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstapDP</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/Longitudinal_Models.html">Longitudinal Models</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/apeterson91/rstapDP/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Longitudinal_Models_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Longitudinal Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/apeterson91/rstapDP/blob/master/vignettes/Longitudinal_Models.Rmd"><code>vignettes/Longitudinal_Models.Rmd</code></a></small>
      <div class="hidden name"><code>Longitudinal_Models.Rmd</code></div>

    </div>

    
    
<div id="motivation" class="section level1">
<h1 class="hasAnchor">
<a href="#motivation" class="anchor"></a>Motivation</h1>
<p>The Introductory vignette demonstrated how to fit Spatial Temporal Aggregated Predictors with Dirichlet Process Priors or STAP-DP models, to data with independent observations. In this vignette we’ll demonstrate how to fit a similar model that now takes into account correlation within subjects, the motivating experimental data structure having subjects followed across time alongside built environment features (BEFs), where changes in exposure correspond to changes in the outcome of interest.</p>
<p>We’ll first introduce this modeling framework in mathematical notation that corresponds to <code>rstapDP</code> syntax. Then, we’ll highlight the importance of decomposing time-varying covariates into between and within subject effects so that they can be estimated separately. Our data for these vignette, <code>complex_longitudinal_cluster</code> but assigned the shorter variable name <code>bdf</code>, is simulated with a hypothetical 700 subjects near FFR’s and 3 varying patterns of FFR effects <strong>high risk</strong> <strong>low risk</strong> and <strong>majority effect</strong> on BMI. These labels should be come clear shortly, if not already. We’ll begin by loading the appropriate libraries and data.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rstapDP</span>)
<span class="co">#&gt; Loading required package: Rcpp</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rbenvo</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'rbenvo'</span>
<span class="co">#&gt; The following object is masked from 'package:rstapDP':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     FFR_subjects</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>())</pre></body></html></div>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">bdf</span>
<span class="co">#&gt; Subject Data:</span>
<span class="co">#&gt; ---------------------------:</span>
<span class="co">#&gt; Observations:  3502</span>
<span class="co">#&gt; Columns:  11</span>
<span class="co">#&gt; Num Subjects:  700</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; BEF Data:</span>
<span class="co">#&gt; ---------------------------:</span>
<span class="co">#&gt; Number of Features:  1</span>
<span class="co">#&gt; Features: </span>
<span class="co">#&gt;   Name Measures</span>
<span class="co">#&gt; 1  FFR Distance</span></pre></body></html></div>
</div>
<div id="longitudinal-stap-dp-model" class="section level1">
<h1 class="hasAnchor">
<a href="#longitudinal-stap-dp-model" class="anchor"></a>Longitudinal STAP-DP Model</h1>
<p>The first class of Longitudinal STAP-DP model’s in the <code>rstapDP</code> package take the following form for a simple spatial aggregated predictor:</p>
<p><span class="math display">\[
E[Y_{ij}|\mathbf{b}_i]  = \mathbf{X}_{ij}^{T}\mathbf{\delta} + f(\mathcal{D}_{ij}) + \mathbf{Z}_{ij}^T\mathbf{b}_i\\
\quad i = 1,...,N ; j= 1,...,n_i\\
\mathbf{b}_i \sim N(0,\Sigma)\\
p(\delta) \propto 1\\
p(\Sigma) \propto 1\\
f_i(\mathcal{D}_i) = \sum_{l=1}^L\sum_{d \in \mathcal{D}}\beta_{il}\phi_l(d)\\
(\beta,\tau) \sim P\\
P \sim DP(\alpha,P_0)\\
P_0 \equiv MVN_L\left(\mathbf{0},\left(\sum_{m=1}^{2}\tau_mS_m \right)^{-1} \right)\prod_{m=1}^{2}Gamma(a,b).
\]</span> To model the hypothetical simulated FFR data, we’ll fit the following model, where the priors are equivalent to the above expression and consequently omitted. <span class="math display">\[
E[BMI_{ij}] = \alpha + (sex_i)\delta_1 + (year_{ij})\delta_2 + f_i(\mathcal{D}_{ij}) + b_{i1} \\
\]</span></p>
<p>The model syntax should be familiar to those who have used the <code>rsstap</code> package before. The <code>sap()</code> keyword denotes that a spatial aggregated predictor will be modeled using the distances in the <code>bdf</code> benvo associated with the <code>FFR</code> BEF-subject data. We’ll sample a few thousand iterations from the gibbs sampler <code>rstapDP</code>, fixing the concentration parameter <span class="math inline">\(\alpha=1\)</span> and take a look at the estimates.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fdp_staplmer.html">fdp_staplmer</a></span>(<span class="no">BMI</span> ~ <span class="no">sex</span> + <span class="no">year</span> +  <span class="fu">sap</span>(<span class="no">FFR</span>) + (<span class="fl">1</span><span class="kw">|</span><span class="no">ID</span>),
                    <span class="kw">benvo</span><span class="kw">=</span><span class="no">bdf</span>,<span class="kw">fix_alpha</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>As can be seen from below, the effects look a little weird.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">fit</span>,<span class="kw">style</span><span class="kw">=</span><span class="st">'facet'</span>,<span class="kw">prob_filter</span><span class="kw">=</span><span class="fl">0.05</span>)</pre></body></html></div>
<p><img src="Longitudinal_Models_files/figure-html/effects-1.png" width="700"></p>
<div id="the-missing-piece" class="section level2">
<h2 class="hasAnchor">
<a href="#the-missing-piece" class="anchor"></a>The Missing Piece</h2>
<p>As alluded to earlier, with time-varying covariates, such as age, income, etc. It is important to <em>decompose</em> the measure into the baseline or between-subject effect and the change, or within-subject effect as these each represent two different effects. Failing to decompose these time-varying measures can result in invalid inference!<span class="citation">(Nehaus and Kalbfleisch 1998)</span></p>
</div>
</div>
<div id="between-within-decomposition-interpretation" class="section level1">
<h1 class="hasAnchor">
<a href="#between-within-decomposition-interpretation" class="anchor"></a>Between-Within Decomposition, Interpretation</h1>
<p>There are a number of ways this decomposition could be be obtained. In the <code>rstapDP</code> model the decomposition takes the following form (keeping all other components the same as in the previous model):</p>
<p><span class="math display">\[
E[BMI_{ij}|b_{i1}] = \alpha + I(Female_i)\delta_1 + (\text{year}_{ij})\delta_2 + \Delta f_i(\text{FFR Exposure}_{ij}) + \bar{f}_i(\text{FFR Exposure}_{i}) + b_{i1} \\\quad i = 1,...,N ; j= 1,...,n_i.
\]</span></p>
<p>Note that both the between-subject effect <span class="math inline">\(\bar{f}_i(\cdot)\)</span> and the within-subject effect <span class="math inline">\(\Delta f_i(\cdot)\)</span> are <strong>clustered together</strong>.</p>
<p>In order to fit this model, we use a similar syntax as before now using <code>sap_bw()</code> as our keyword to denote that a between-within decomposition will be performed on the design matrix associated with the FFR spatial exposure function.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fdp_staplmer.html">fdp_staplmer</a></span>(<span class="no">BMI</span> ~ <span class="no">sex</span> + <span class="no">year</span> +  <span class="fu">sap_bw</span>(<span class="no">FFR</span>) + (<span class="fl">1</span><span class="kw">|</span><span class="no">ID</span>),
                    <span class="kw">benvo</span><span class="kw">=</span><span class="no">bdf</span>,<span class="kw">fix_alpha</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">fit</span>,<span class="kw">prob_filter</span><span class="kw">=</span><span class="fl">0.05</span>)</pre></body></html></div>
<p><img src="Longitudinal_Models_files/figure-html/plotbw-1.png" width="700"></p>
<p>Plotting this model, we can now see that there <strong>are</strong> in fact, different effects both between and within subjects. These estimates also make a lot more sense visually compared to the previous plots that assumed the between-within effects were the same. ## Summary</p>
<p>In closing this vignette demonstrated how to use the <code>rstapDP</code> package to model heterogeneous effects of built environment features with longitudinal data, taking into account differences in between-within subject effects.</p>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-kalbfleisch">
<p>Nehaus, John, and Jack Kalbfleisch. 1998. “Between-and Within-Cluster Covariate Effects in the Analysis of Clustered Data.” <em>Biometrics</em>, June, 638–45. <a href="https://doi.org/10.2307/3109770">https://doi.org/10.2307/3109770</a>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Adam Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
